name: Check Docker

on:
  push:
    branches: [main, holoscan-sdk-lws2, impl-bench, temp-test]

permissions:
  contents: read

jobs:
  check-docker-build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Run Docker build
        run: |
          export ubuntu_version=22.04
          ./holohub build-container --dryrun --no-cache
          ./holohub build-container --dryrun --build-args "--build-arg TEST=value"
          ./holohub build-container --base-img ubuntu:${ubuntu_version}
          if ! command -v nvidia-ctk >/dev/null 2>&1; then
            sed -i 's/check_nvidia_ctk()/print("no check")/g' utilities/cli/container.py
            sed -i 's/            "--runtime=nvidia",/            # "--runtime=nvidia",/' utilities/cli/container.py
            sed -i 's/            "--gpus",/            # "--gpus",/' utilities/cli/container.py
            sed -i 's/            "all",/            # "all",/' utilities/cli/container.py
            echo "Replaced check_nvidia_ctk() call and commented out NVIDIA runtime args since nvidia-ctk is not available"
          fi
          ./holohub run-container --base-img ubuntu:${ubuntu_version} --no-docker-build
          ./holohub run-container --dryrun --docker-opts "--memory 4g"
          ./holohub run-container --dryrun --add-volume "/tmp"
          ./holohub run-container --docker-opts "--memory 4g" --no-docker-build
          ./holohub run-container --no-x11 --no-docker-build --add-volume "/tmp"
