#!/usr/bin/env bash

# SPDX-FileCopyrightText: Copyright (c) 2025 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# ==============================================================================
# HoloHub CLI Wrapper
# ==============================================================================
#
# DESCRIPTION:
#   This wrapper automatically downloads and manages the HoloHub CLI from the
#   nvidia-holoscan/holohub repository. It uses sparse checkout to fetch only
#   the required utilities and pins to a specific commit for stability.
#
# USAGE:
#   ./holohubCLI_wrapper [CLI_OPTIONS]
#
# ENVIRONMENT VARIABLES:
#   CLI_REPO_URL       - Repository URL (default: https://github.com/nvidia-holoscan/holohub.git)
#   CLI_PINNED_COMMIT  - Commit hash to checkout (default: 304ac2639ab004368c8ed9b3f2a47de2521969ca)
#   CLI_FORCE_UPDATE   - Set to "1" to force re-download even if CLI exists
#
# EXAMPLES:
#   # First run - downloads CLI automatically
#   ./holohubCLI_wrapper --help
#
#   # Force update to the pinned commit
#   CLI_FORCE_UPDATE=1 ./holohubCLI_wrapper --help
#
#   # Use custom repository or commit
#   CLI_FORCE_UPDATE=1 CLI_PINNED_COMMIT="abc123def456" ./holohubCLI_wrapper --help
#
# ==============================================================================

set -e
set -o pipefail

SCRIPT_PATH="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TMP_HOLOHUB_DIR="${SCRIPT_PATH}/.tmp-holohub"
REPO_URL="${CLI_REPO_URL:-https://github.com/nvidia-holoscan/holohub.git}"
CLI_PINNED_COMMIT="${CLI_PINNED_COMMIT:-304ac2639ab004368c8ed9b3f2a47de2521969ca}"

if [ -z "${CLI_PINNED_COMMIT}" ]; then
    echo "Error: CLI_PINNED_COMMIT must be set to a valid commit hash."
    exit 1
fi

cleanup_tmp() {
    rm -rf "${TMP_HOLOHUB_DIR}"
}

cleanup_on_error() {
    local exit_code=$?
    cleanup_tmp
    exit "${exit_code}"
}

trap cleanup_on_error ERR

download_cli() {
    echo "Downloading holohub CLI..."
    cleanup_tmp
    rm -rf "${SCRIPT_PATH}/utilities"
    rm -rf "${SCRIPT_PATH}/cmake"

    git clone --no-checkout --filter=blob:none --quiet "${REPO_URL}" "${TMP_HOLOHUB_DIR}/holohub"

    cd "${TMP_HOLOHUB_DIR}/holohub"
    git sparse-checkout init --cone >/dev/null 2>&1
    git sparse-checkout set utilities/cli utilities/metadata utilities/testing utilities/setup cmake >/dev/null 2>&1

    git fetch --quiet origin "${CLI_PINNED_COMMIT}"
    git -c advice.detachedHead=false checkout --quiet "${CLI_PINNED_COMMIT}"

    local COMMIT_HASH
    COMMIT_HASH=$(git rev-parse HEAD 2>/dev/null)

    mv "${TMP_HOLOHUB_DIR}/holohub/utilities" "${SCRIPT_PATH}"
    mv "${TMP_HOLOHUB_DIR}/holohub/cmake" "${SCRIPT_PATH}"

    cleanup_tmp
    cd "${SCRIPT_PATH}"
    echo "${COMMIT_HASH}" > "${SCRIPT_PATH}/utilities/cli/.cli_commit_hash"
}

# Check if CLI needs to be downloaded or force-updated (including the first time run)
if [ "${CLI_FORCE_UPDATE}" = "1" ] || [ ! -d "${SCRIPT_PATH}/utilities/cli" ]; then
    download_cli || { echo "Error: Failed to download CLI"; exit 1; }
    echo "âœ“ CLI downloaded successfully"
fi

export HOLOHUB_CMD_NAME=${BASH_SOURCE[0]}

PYTHONPATH=${PYTHONPATH}:${SCRIPT_PATH} python3 ${SCRIPT_PATH}/utilities/cli/holohub.py "$@" || CLI_EXIT_CODE=$?

# Check for CLI version has after command completes
if [ -f "${SCRIPT_PATH}/utilities/cli/version_check.py" ]; then
    export CLI_PINNED_COMMIT
    PYTHONPATH=${PYTHONPATH}:${SCRIPT_PATH} python3 ${SCRIPT_PATH}/utilities/cli/version_check.py 2>/dev/null || true
fi
exit ${CLI_EXIT_CODE:-0}
